name: Linkumori crx packaging and Release

permissions:
  contents: write  

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag Name (e.g., v1.0.0)'
        required: true
      release_title:
        description: 'Release Title'
        required: true
      release_notes:
        description: 'Release Notes'
        required: true

jobs:
  pack-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare clean directory
        run: |
          mkdir clean_ext
          rsync -av --exclude='*.pem' --exclude='.git*' --exclude='.github' . clean_ext/

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Pack Extension
        run: |
          google-chrome --pack-extension="$(pwd)/clean_ext"
          mv clean_ext.crx "${{ github.event.repository.name }}.crx"
          
      - name: Create Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_title }}
          body: |
            ${{ github.event.inputs.release_notes }}
            
            ## Installation
            Download the .crx file and install in Chrome.
          files: ${{ github.event.repository.name }}.crx
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Existing Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ github.event.repository.name }}.crx
          body: |
            ## Installation
            Download the .crx file and install in Chrome.
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: rm -rf clean_ext
