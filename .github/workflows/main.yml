name: Linkumori Builds and Release

permissions:
  contents: write

on:
  release:
    types: [created]

jobs:
  pack-and-release:
    runs-on: ubuntu-latest
    env:
      EXTENSION_ID: kcpfnbjlimolkcjllfooaipdpdjmjigg
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CONFIG
        run: |
          wget https://github.com/subham8907/Linkumori-Autoupdate/archive/refs/tags/1.0.zip -O config.zip
          echo "Downloaded configs"

      # Your existing PEM file step
      - name: Create PEM file
        run: |
          cat > extension.pem << 'EOL'
          -----BEGIN PRIVATE KEY-----
          MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCp8Q+kavs7radl
          ...
          -----END PRIVATE KEY-----
          EOL
          chmod 600 extension.pem

      - name: Prepare clean directory
        run: |
          mkdir clean_ext
          rsync -av --exclude='*.pem' --exclude='.git*' --exclude='.github' --exclude='*.crx' . clean_ext/

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Fetch manifest version
        id: manifest
        run: |
          MANIFEST_VERSION=$(curl -s https://raw.githubusercontent.com/subham8907/Linkumori/main/manifest.json | jq -r '.version')
          echo "version=$MANIFEST_VERSION" >> $GITHUB_OUTPUT

      - name: Pack Extension
        run: |
          google-chrome --pack-extension="$(pwd)/clean_ext" --pack-extension-key="$(pwd)/extension.pem"
          mv clean_ext.crx "Linkumori.crx"
          
          # Generate updates.xml with version from manifest.json
          cat > updates.xml << EOL
          <?xml version='1.0' encoding='UTF-8'?>
          <gupdate xmlns='http://www.google.com/update2/response' protocol='2.0'>
            <app appid="kcpfnbjlimolkcjllfooaipdpdjmjigg">
              <updatecheck 
                codebase='https://github.com/subham8907/Linkumori/releases/download/${{ github.event.release.tag_name }}/Linkumori.crx' 
                version='${{ steps.manifest.outputs.version }}' />
            </app>
          </gupdate>
          EOL

      - name: Get Release Body
        id: get_release_body
        run: |
          body=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}" \
            | jq -r .body)
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$body" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Linkumori.crx
            updates.xml
            config.zip
          body: |
            ${{ env.RELEASE_BODY }}
            ## ‚ö° Quick Installation
            ### Method 1: One-Click Install (Recommended)
            1. Download `Linkumori.crx` from above
            2. Open chrome://extensions (or edge://extensions)
            3. Enable "Developer mode" (top-right corner)
            4. Drag & drop the .crx file into the extensions page
            ### Method 2: Developer Installation
            1. Download source code (zip)
            2. Extract to a folder
            3. Go to chrome://extensions
            4. Enable "Developer mode"
            5. Click "Load unpacked" ‚Üí select the extracted folder
            ## üîÑ Auto-Updates
            * The extension will automatically check for and install updates
            * Updates are delivered through GitHub releases
            ## üåê Supported Browsers
            * ‚úÖ Google Chrome
            * ‚úÖ Microsoft Edge
            * ‚úÖ Brave
            * ‚úÖ Opera GX
            * ‚úÖ Vivaldi
            ## ‚ö†Ô∏è Keep in Mind
            * If using Method 2, keep the source folder (required for the extension to work)
            * First-time installation may show a warning - this is normal for developer mode extensions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push to Another Repo (web.linkumori)
        run: |
          # Configure git with your user name and email for commits
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clone the target repository (web.linkumori)
          git clone https://github.com/subham8907/web.linkumori.git
          
          # Copy the .crx file into the repository
          cp Linkumori.crx web.linkumori/
          
          # Commit and push the .crx file to the main branch of web.linkumori
          cd web.linkumori
          git checkout main
          git add Linkumori.crx
          git commit -m "Add latest Linkumori extension .crx file"
          git push origin main

      - name: Cleanup
        if: always()
        run: |
          rm -rf clean_ext
          rm -f extension.pem
          rm -f *.crx
          rm -f *.zip
